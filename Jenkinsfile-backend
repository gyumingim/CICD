pipeline {
    agent any
    
    environment {
        DOCKERHUB_REPO = 'gyumingim/backend'
        IMAGE_TAG = "${BUILD_NUMBER}"
        SERVER_HOST = '192.168.1.45'
    }
    
    stages {
        stage('Test') {
            steps {
                echo 'Running backend tests...'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    dir('backend') {
                        docker.build("${DOCKERHUB_REPO}:${IMAGE_TAG}")
                        docker.build("${DOCKERHUB_REPO}:latest")
                    }
                }
            }
        }
        
        stage('Push to Docker Hub') {
            steps {
                script {
                    docker.withRegistry('https://registry.hub.docker.com', 'dockerhub-credentials') {
                        docker.image("${DOCKERHUB_REPO}:${IMAGE_TAG}").push()
                        docker.image("${DOCKERHUB_REPO}:latest").push()
                    }
                }
            }
        }
        
        stage('Deploy to Raspberry Pi') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'pi-ssh-password',
                    usernameVariable: 'SSH_USER',
                    passwordVariable: 'SSH_PASS'
                )]) {
                    sh """
                        sshpass -p "\${SSH_PASS}" ssh -o StrictHostKeyChecking=no \${SSH_USER}@${SERVER_HOST} '
                            cd ~/app &&
                            docker pull ${DOCKERHUB_REPO}:latest &&
                            docker-compose up -d backend
                        '
                    """
                }
            }
        }
    }
    
    post {
        always {
            sh 'docker system prune -f'
        }
        success {
            echo 'Backend deployment successful!'
        }
        failure {
            echo 'Backend deployment failed!'
        }
    }
}